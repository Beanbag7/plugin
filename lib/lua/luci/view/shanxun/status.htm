<%+header%>
<h2>闪讯自动拨号 - 状态</h2>

<div class="cbi-section">
  <div id="sx-status" style="margin:6px 0;padding:6px;border:1px solid #ddd;">
    <pre id="sx-json" style="white-space:pre-wrap;word-break:break-all;"><%=luci.sys.exec("/usr/bin/shanxun-autodial status 2>/dev/null")%></pre>
  </div>

  <div class="cbi-page-actions">
    <button class="btn cbi-button" onclick="sxAct('check')">立即检测</button>
    <button class="btn cbi-button cbi-button-apply" onclick="sxAct('refresh')">短信取密并更新</button>
    <button class="btn cbi-button" onclick="sxAct('redial')">重拨</button>
    <button class="btn cbi-button cbi-button-reset" onclick="if(confirm('确认一键卸载？这会删除脚本和 LuCI 页面。')) sxAct('uninstall')">一键卸载</button>
  </div>

  <h3>最近日志（20 行）</h3>
  <pre style="max-height:320px;overflow:auto;"><%=luci.sys.exec("tail -n 20 $(uci -q get shanxun.config.log_file 2>/dev/null || echo /var/log/shanxun.log) 2>/dev/null")%></pre>
</div>

<script>
function sxAct(m){
  fetch('<%=luci.dispatcher.build_url("admin","network","shanxun","action")%>?m='+m, {method:'GET'})
    .then(r => r.json()).then(_ => location.reload());
}
</script>
<%+footer%>
